<!DOCTYPE html>
<!-- saved from url=(0061)http://fecore.net.ua/javascript/pages/theory/module-10-2.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><title>Module 10</title><link rel="stylesheet" href="./Module 10-2_files/styles.min.css"><script async="" src="./Module 10-2_files/ei.js.Без названия"></script><script async="" src="./Module 10-2_files/scripts.min.js.Без названия"></script></head><body class="theory-page"><div class="wrapper"><article><header><nav class="table-of-contents" id="main-nav"><ol class="page-nav" id="page-nav"><li><a href="http://fecore.net.ua/javascript/pages/theory/module-10-2.html#cookies">Cookies</a></li><li><a href="http://fecore.net.ua/javascript/pages/theory/module-10-2.html#webstorage">WebStorage</a></li><li><a href="http://fecore.net.ua/javascript/pages/theory/module-10-2.html#ls-module">Модуль для localStorage</a></li><li><a href="http://fecore.net.ua/javascript/pages/theory/module-10-2.html#idexeddb">IndexedDB</a></li><li><a href="http://fecore.net.ua/javascript/pages/theory/module-10-2.html#resoures">Дополнительные материалы</a></li></ol></nav></header><section><h2 id="cookies">Cookies</h2><p>Основная проблема веб-приложений - при использовании приложения и закрытии, его состояние будет сброшено при следующем посещении. Если вы закрываете приложение на рабочем столе и снова открываете его, последнее состояние восстанавливается. Вот почему, как разработчику, вам нужно где-то сохранить состояние своего интерфейса.</p><p>Обычно это делается на стороне сервера, и необходимо проверить имя пользователя, чтобы узнать, к какому состоянию нужно вернуться. Но что, если регистрация не обязательна? На помощь приходит хранение информации о состоянии приложения на компьютере пользователя. Точно так же, как сервер может хранить информацию об отдельном пользователе, браузер также может хранить информацию.</p><p>Классический способ сделать это - использовать <code>cookie</code>. Файл <code>cookie</code> представляет собой текстовый файл, размещенный на компьютере пользователя и подключенный к домену, на котором работает ваш сайт. Вы можете хранить информацию в них, читать и удалять.</p><p>Например, вы можете использовать файлы cookie для запоминания настроек пользователя, отображения их имени или отображения последнего посещения сайта. Куки-файлы представляют собой текстовые строки пар ключ/значение в списке, разделенном запятыми.</p><p>Но у <code>Cookies</code> есть несколько ограничений.</p><ul><li>Они добавляют к загрузке каждого документа, доступного в домене.</li><li>Они позволяют хранить всего до 4 КБ данных, что довольно мало.</li><li>Поскольку файлы cookie используются для отслеживания поведения людей в серфинге, люди и компании, которые сознают безопасность, отключают их или просят каждый раз спрашивать, нужно ли устанавливать <code>cookie</code>.</li><li>Используя куки, довольно проблематично отслеживать две или более транзакций на одном и том же сайте, что может происходить одновременно в разных вкладках.</li></ul><p><a href="https://sabe.io/classes/javascript/cookies" target="_blank" rel="noopener">Cookies: Storing Data on the Client</a></p></section><section><h2 id="webstorage">WebStorage</h2><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API" target="_blank"><strong>Web Storage API</strong> </a>включает в себя локальное хранилище (localStorage) и хранилище сеансов (sessionStorage), и предлагает нам способ хранения пар ключ/значение более интуитивно понятным способом, чем использование cookie.</p><p>При этом существенное различие между cookie и веб-хранилищем заключается в том, что сервер может считывать файлы cookie из браузера пользователя, но не может напрямую считывать данные из локального / сеансового хранилища. Поэтому они имеют несколько разные назначения использования.</p><p>Например, если пользователь покупает авиабилеты в двух разных окнах, используя тот же сайт. Если на сайте использовались файлы cookie для отслеживания того, какой билет покупал пользователь, тогда, когда пользователь перешел между вкладками, приобретаемый билет «перетечет» из одной вкладки в другую, что может привести к тому, что пользователь купит два билета на тот же рейс, не заметив.</p><p><strong>sessionStorage</strong> — используется сайтами для добавления данных в хранилище сеансов, и данные этого хранилища будут доступны для любой страницы с того же сайта, открытого в этом окне, т.е. сессии, и как только окно будет закрыто, сеанс будет завершен, а хранилище сеансов очищено.</p><p><strong>localStorage</strong> — хранилище, которое охватывает несколько окон и сохранятеся после текущего сеанса. В частности, веб-приложения могут сохранить пользовательские данные, такие как настройки профиля или данные последнего запроса на сервер, на стороне клиента.</p><h3>localStorage</h3><p><strong>localStorage (локальное хранилище)</strong> - позволяет хранить пары <code>ключ:значение</code> на компьютере пользователя и читать их, когда пользователь снова вернется на страницу.</p><p>Локальное хранилище является частью веб-хранилища, которое само по себе является частью спецификации HTML5. Существует два варианта хранения данных в спецификации:</p><ul><li><strong>Локальное хранилище</strong>: хранит данные без истечения срока действия, и это тот, который мы будем использовать, потому что мы хотим, чтобы наши дела оставались на странице как можно дольше.</li><li><strong>Хранение сеанса</strong>: сохраняет только данные для одного сеанса, поэтому, если пользователь закрывает вкладку и снова открывает ее, все их данные исчезнут.</li></ul><p>Проще говоря, веб-хранилище локально хранит пары ключ/значение, и в отличие от куки-файлов эти данные сохраняются даже при закрытии браузера или выключении компьютера.</p><p>Использование локального хранилища в современных браузерах очень просто. Все, что вам нужно сделать, это изменить объект <code>localStorage</code> в JavaScript. Вы можете сделать это использовуя методы <code>setItem</code>, <code>getItem</code> и <code>removeItem</code>.</p><h4>Сохранение данных</h4><p>Используя метод <code>setItem</code> можно записать пару <code>ключ/значение</code>.</p><pre class=" language-javascript"><code class=" language-javascript">localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'theme'</span><span class="token punctuation">,</span><span class="token string">'light'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Одним из неприятных недостатков локального хранилища является то, что вы можете хранить только строки. Это означает, что когда у вас есть объект, он не будет сохранен правильно. Вы можете обойти это, используя методы объекта <code>JSON</code>.</p><pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword keyword-const">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>
  theme<span class="token punctuation">:</span> <span class="token string">'dark'</span><span class="token punctuation">,</span>
  isAuthenticated<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  options<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span> <span class="token string">"settings"</span><span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4>Чтение данных</h4><p>Чтение данных из локального хранилища - это тот же процесс, что и сохранение данных, но в обратном порядке. Вместо <code>setItem</code> вы используете <code>getItem</code>.</p><p>Если вы знаете, что значение это обычная строка, вы можете просто прочитать ее без необходимости разбирать что-либо.</p><pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword keyword-const">const</span> value <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>В противном случае, необходимо распарсить значение, чтобы вернуть исходный JavaScript-объект. Используем пример с настройками.</p><pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword keyword-const">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>
  theme<span class="token punctuation">:</span> <span class="token string">'dark'</span><span class="token punctuation">,</span>
  isAuthenticated<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  options<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span> <span class="token string">"settings"</span><span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-const">const</span> settingsFromLS <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">"settings"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>settingsFromLS<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4>Удаление данных</h4><p>Для того чтобы удалить пару, необходимо вызвать метод <code>removeItem</code> и передать ему ключ.</p><pre class=" language-javascript"><code class=" language-javascript">localStorage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span><span class="token string">'ключ'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4>Очистка хранилища</h4><p>Если вы хотите полностью очистить хранилище, вызовите метод <code>clear</code>.</p><pre class=" language-javascript"><code class=" language-javascript">localStorage<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3>Пример</h3><p>Создадим поле для вывода и кнопку для сохранения введенного в <code>localStorage</code>. Изначально такой пары в хранилище нету поэтому будет выведена пустая строка.</p><p>Попробуйте позаполнять <code>input</code> и нажмите <code>Save</code>. Текст в поле вывода изменится на тот что ввели. Перезагрузите страницу, все тот же текст, хотя вы ничего еще не вводили. Мы берем его из <code>localStorage</code>, последнее веденное значение.</p><div class="cp_embed_wrapper"><iframe id="cp_embed_veORaG" src="./Module 10-2_files/veORaG.html" scrolling="no" frameborder="0" height="400" allowtransparency="true" allowfullscreen="true" allowpaymentrequest="true" name="CodePen Embed" title="module-10-localstorage" class="cp_embed_iframe " style="width: 100%; overflow: hidden;"></iframe></div><p>Посмотреть содержимое localStorage можно на вкладке Application.</p><img src="./Module 10-2_files/local-storage.png" alt="ls"></section><section><h2 id="ls-module">Модуль для localStorage</h2><p>Мы уже умеем работать с <code>localStorage</code>, можем записать, прочитать или удалить. Следующим шагом будет правильное, осмысленное использование <code>localStorage</code>. Что будет если <code>getItem</code> или <code>setItem</code>ничего не вернет? А есть ли <code>localStorage</code> вообще в объекте <code>window</code> браузера пользователя? - если нету, то скрипт попросту упадет при попытке обращения к <code>localStorage</code>.</p><p>Давайте напишем модуль для определения наличия и безопасной работы с <code>localStorage</code>. Для начала создадим глобальную константу для модуля и присвоим ей результат выполнения <code>IIFE</code>, чтобы скрыть реализацию внутри.</p><p>Единственным параметром <code>IIFE</code> будет принимать объект <code>window</code> для того чтобы проверить есть ли он вообще в глобальном неймспейсе, если нет то сразу выходим.</p><p>После проверки наличия объекта <code>window</code> создадим переменную <code>isActive</code>, значение которой будет результат проверки наличия ключа <code>"localStorage"</code> в объекте <code>window</code>. Так мы можем сигнализировать пользователю нашего модуля о доступности <code>localStorage</code>.</p><pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword keyword-const">const</span> LOCALSTORAGE <span class="token operator">=</span> <span class="token punctuation">(</span>w <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>w<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-const">const</span> isActive <span class="token operator">=</span> <span class="token string">"localStorage"</span> <span class="token keyword keyword-in">in</span> w<span class="token punctuation">;</span>

  <span class="token keyword keyword-const">const</span> publicAPI <span class="token operator">=</span> <span class="token punctuation">{</span>
    isActive
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-return">return</span> publicAPI<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Следующим шагом будет создание методов для записи и чтения <code>localStorage</code>, назовем их <code>get</code> и <code>set</code>.</p><p>Метод <code>get</code> принимает только ключ <code>key</code> по которому будет произведена выборка. Метод <code>set</code> принимает ключ <code>key</code> и значение <code>value</code>. Использовать их можно будет следующим образом <code>LOCALSTORAGE.get(...)</code> и <code>LOCALSTORAGE.set(...)</code>.</p><p>Обязательно оборачиваем все в <code>try/catch</code> и при ошибке выводим <code>err</code> в консоль.</p><pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword keyword-const">const</span> LOCALSTORAGE <span class="token operator">=</span> <span class="token punctuation">(</span>w <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>w<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>

<span class="token keyword keyword-const">const</span> isActive <span class="token operator">=</span> <span class="token string">"localStorage"</span> <span class="token keyword keyword-in">in</span> w<span class="token punctuation">;</span>

<span class="token keyword keyword-const">const</span> <span class="token function-variable function">get</span> <span class="token operator">=</span> key <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-const">const</span> serializedState <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-return">return</span> serializedState <span class="token operator">===</span> <span class="token keyword keyword-null">null</span>
      <span class="token operator">?</span> undefined
      <span class="token punctuation">:</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>serializedState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Get state error: "</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-const">const</span> <span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-const">const</span> serializedState <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> serializedState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Set state error: "</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-const">const</span> publicAPI <span class="token operator">=</span> <span class="token punctuation">{</span>
  isActive<span class="token punctuation">,</span>
  <span class="token keyword keyword-get">get</span><span class="token punctuation">,</span>
  <span class="token keyword keyword-set">set</span> <span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-return">return</span> publicAPI<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>LOCALSTORAGE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {isActive: true, get: ƒ, set: ƒ}</span></code></pre><p>Теперь мы можем проверить доступен ли <code>localStorage</code> в браузере пользователя, и безопасно записывать и читать <code>localStorage</code>. Попробуйте сами дописать еще методы <code>remove</code> и <code>clear</code>, аналогично <code>get</code> и <code>set</code>.</p></section><section><h2 id="idexeddb">IndexedDB</h2><p><strong>IndexedDB</strong> - новая концепция для хранения данных в браузере пользователя, пришедшая с HTML5. Это хранилище больше, чем локальное, и полезно для приложений, требующих хранения большого количества данных. Благодаря этому, приложения могут работать и загружаться быстрее.</p><ul><li>Сохраняет пары ключ/значение, как и localStorage</li><li>Это <a href="http://sernam.ru/book_cbd.php?id=2" target="_blank">не реляционная</a> база данных</li><li>Имеет, в основном, асинхронный API</li><li>Это не структурированный язык запросов</li><li>Поддерживает доступ к данным из того же домена</li></ul><h3>Материалы для изучения</h3><p>Ниже приведен набор статей с теорией и примерами. Не спешите углубляться в <strong>IndexedDB</strong>, данная технология упоминается для общего ознакомления, нет смысла использовать это хранилище для тривиальных задач, для этого хватит <strong>localStorage</strong>.</p><ul><li><a href="https://habrahabr.ru/post/213515/" targt="_blank">Готовим IndexedDB</a></li><li><a href="https://developers.google.com/web/ilt/pwa/working-with-indexeddb" targt="_blank">Working with IndexedDB (google)</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API" targt="_blank">IndexedDB API (MDN)</a></li></ul></section><section><h2 id="resoures">Дополнительные материалы</h2><ul><li><a href="http://prgssr.ru/development/obzor-sredstv-hraneniya-dannyh-na-klientskoj-storone.html" target="_blank">Обзор средств хранения данных на стороне клиента</a></li><li><a href="https://dev.opera.com/articles/web-storage/" target="_blank" rel="noopener">Web Storage: Easier, More Powerful Client-Side Data Storage</a></li><li><a href="http://diveinto.html5doctor.com/storage.html" target="_blank" rel="noopener">The past, preset and future of local storage for web applications</a></li></ul></section></article><a href="http://fecore.net.ua/javascript/pages/theory/module-10-2.html#main-nav" class="to-page-nav"></a></div></body></html>